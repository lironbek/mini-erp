generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================
// ENUMS
// ============================================================

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  LOCKED
  IN_PRODUCTION
  READY
  DISPATCHED
  DELIVERED
  CANCELLED
}

enum OrderSource {
  EMAIL
  WHATSAPP
  ARIBA
  MANUAL
  PORTAL
}

enum ProductionLine {
  BAKERY
  SALADS
  FROZEN
}

enum MovementType {
  PURCHASE_RECEIPT
  PRODUCTION_INPUT
  PRODUCTION_OUTPUT
  ADJUSTMENT_PLUS
  ADJUSTMENT_MINUS
  WASTE
  COUNT
  RETURN_TO_SUPPLIER
  DAMAGED
}

enum UnitOfMeasure {
  KG
  G
  LITER
  ML
  PCS
  PACK
  CARTON
  PALLET
}

enum ItemType {
  RAW_MATERIAL
  FINISHED_GOOD
}

enum CountType {
  FULL
  PARTIAL
  SPOT_CHECK
}

enum UserRole {
  ADMIN
  MANAGER
  PRODUCTION
  WAREHOUSE
  SALES
  VIEWER
}

// ============================================================
// USERS & PERMISSIONS
// ============================================================

model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String
  name              String
  role              UserRole  @default(VIEWER)
  preferredLanguage String    @default("en")
  phone             String?
  image             String?
  isActive          Boolean   @default(true)
  lastLogin         DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  auditLogs         AuditLog[]
  notifications     Notification[]
  createdOrders     Order[]          @relation("OrderCreatedBy")
  updatedOrders     Order[]          @relation("OrderUpdatedBy")
  lockedOrders      Order[]          @relation("OrderLockedBy")
  orderChanges      OrderChange[]
  createdWorkOrders WorkOrder[]      @relation("WorkOrderCreatedBy")
  productionReports ProductionReport[]
  inventoryMovements InventoryMovement[]
  createdPOs        PurchaseOrder[]  @relation("POCreatedBy")
  inventoryCountsCounted InventoryCount[] @relation("CountCounted")
  inventoryCountsApproved InventoryCount[] @relation("CountApproved")
  settingsUpdated   SystemSetting[]

  @@map("users")
}

// ============================================================
// CUSTOMERS
// ============================================================

model Customer {
  id                  String    @id @default(uuid())
  externalId          String?
  externalSystem      String?   // 'ariba', 'freshbooks'
  name                Json      // {"en": "Marina Bay Sands", "he": "..."}
  shortName           String?
  contactName         String?
  email               String?
  phone               String?
  whatsappNumber      String?
  deliveryAddress     String?
  billingAddress      String?
  defaultDeliverySlot String?   // e.g., "06:00-08:00"
  orderCutoffTime     String?   // e.g., "18:00"
  paymentTerms        Int       @default(30)
  creditLimit         Decimal?  @db.Decimal(12, 2)
  currency            String    @default("SGD")
  notes               String?
  isActive            Boolean   @default(true)
  tags                Json      @default("[]")
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  orders              Order[]

  @@index([externalSystem, externalId])
  @@index([whatsappNumber])
  @@map("customers")
}

// ============================================================
// SUPPLIERS
// ============================================================

model Supplier {
  id               String    @id @default(uuid())
  xeroContactId    String?
  name             Json
  shortName        String?
  contactName      String?
  email            String?
  phone            String?
  address          String?
  country          String    @default("Singapore")
  paymentTerms     Int       @default(30)
  currency         String    @default("SGD")
  deliveryDays     Json      @default("[]")    // [1,2,3,4,5]
  deliveryTimeSlots Json     @default("[]")    // ["06:00-08:00"]
  minOrderAmount   Decimal?  @db.Decimal(10, 2)
  leadTimeDays     Int       @default(3)
  rating           Decimal?  @db.Decimal(3, 2)
  isActive         Boolean   @default(true)
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  primaryMaterials   RawMaterial[] @relation("PrimarySupplier")
  secondaryMaterials RawMaterial[] @relation("SecondarySupplier")
  purchaseOrders     PurchaseOrder[]

  @@map("suppliers")
}

// ============================================================
// PRODUCTS (Finished Goods)
// ============================================================

model Product {
  id                     String         @id @default(uuid())
  sku                    String         @unique
  barcode                String?
  name                   Json           // Multi-language names
  description            Json           @default("{}")
  category               String?        // "pita", "flatbread", "salad", "frozen"
  productionLine         ProductionLine
  unitOfMeasure          UnitOfMeasure  @default(PCS)
  unitsPerPack           Int            @default(1)
  packWeightKg           Decimal?       @db.Decimal(8, 3)
  shelfLifeDays          Int
  minStockLevel          Decimal        @default(0) @db.Decimal(10, 2)
  maxStockLevel          Decimal?       @db.Decimal(10, 2)
  reorderPoint           Decimal?       @db.Decimal(10, 2)
  standardBatchSize      Decimal?       @db.Decimal(10, 2)
  productionLeadTimeHours Decimal       @default(4) @db.Decimal(5, 1)
  sellingPrice           Decimal?       @db.Decimal(10, 2)
  costPrice              Decimal?       @db.Decimal(10, 2)
  freshbooksItemId       String?
  labelTemplateId        String?
  isActive               Boolean        @default(true)
  imageUrl               String?
  notes                  String?
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt

  // Relations
  boms                   Bom[]
  orderItems             OrderItem[]
  workOrderItems         WorkOrderItem[]
  inventoryStock         InventoryStock[]
  inventoryMovements     InventoryMovement[]

  @@index([category])
  @@index([productionLine])
  @@map("products")
}

// ============================================================
// RAW MATERIALS
// ============================================================

model RawMaterial {
  id                   String        @id @default(uuid())
  sku                  String        @unique
  name                 Json
  description          Json          @default("{}")
  category             String?       // "flour", "oil", "spice", "packaging"
  unitOfMeasure        UnitOfMeasure @default(KG)
  minStockLevel        Decimal       @default(0) @db.Decimal(10, 2)
  maxStockLevel        Decimal?      @db.Decimal(10, 2)
  reorderPoint         Decimal?      @db.Decimal(10, 2)
  reorderQuantity      Decimal?      @db.Decimal(10, 2)
  leadTimeDays         Int           @default(7)
  primarySupplierId    String?
  secondarySupplierId  String?
  lastPurchasePrice    Decimal?      @db.Decimal(10, 4)
  averagePurchasePrice Decimal?      @db.Decimal(10, 4)
  xeroItemId           String?
  storageLocation      String?       // "dry_store", "chiller_1", "freezer"
  storageTempMin       Decimal?      @db.Decimal(5, 1)
  storageTempMax       Decimal?      @db.Decimal(5, 1)
  isAllergen           Boolean       @default(false)
  allergenInfo         String?
  isActive             Boolean       @default(true)
  notes                String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  // Relations
  primarySupplier      Supplier?     @relation("PrimarySupplier", fields: [primarySupplierId], references: [id])
  secondarySupplier    Supplier?     @relation("SecondarySupplier", fields: [secondarySupplierId], references: [id])
  bomItems             BomItem[]
  inventoryStock       InventoryStock[]
  inventoryMovements   InventoryMovement[]
  purchaseOrderItems   PurchaseOrderItem[]

  @@map("raw_materials")
}

// ============================================================
// BILL OF MATERIALS (BOM)
// ============================================================

model Bom {
  id                String        @id @default(uuid())
  productId         String
  version           Int           @default(1)
  name              Json?
  isActive          Boolean       @default(true)
  yieldPercentage   Decimal       @default(100) @db.Decimal(5, 2)
  standardBatchSize Decimal?      @db.Decimal(10, 2)
  batchUnit         UnitOfMeasure @default(KG)
  notes             String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  product           Product       @relation(fields: [productId], references: [id])
  items             BomItem[]
  workOrderItems    WorkOrderItem[]

  @@unique([productId, version])
  @@map("bom")
}

model BomItem {
  id              String        @id @default(uuid())
  bomId           String
  rawMaterialId   String
  quantity        Decimal       @db.Decimal(10, 4)
  unit            UnitOfMeasure
  wastePercentage Decimal       @default(0) @db.Decimal(5, 2)
  isOptional      Boolean       @default(false)
  sortOrder       Int           @default(0)
  notes           String?

  // Relations
  bom             Bom           @relation(fields: [bomId], references: [id], onDelete: Cascade)
  rawMaterial     RawMaterial   @relation(fields: [rawMaterialId], references: [id])

  @@unique([bomId, rawMaterialId])
  @@map("bom_items")
}

// ============================================================
// ORDERS
// ============================================================

model Order {
  id                     String      @id @default(uuid())
  orderNumber            String      @unique // ORD-YYYYMMDD-XXXX
  customerId             String
  source                 OrderSource
  sourceReference        String?
  status                 OrderStatus @default(PENDING)
  orderDate              DateTime    @default(now()) @db.Date
  requestedDeliveryDate  DateTime    @db.Date
  confirmedDeliveryDate  DateTime?   @db.Date
  deliverySlot           String?
  lockedAt               DateTime?
  lockedById             String?
  subtotal               Decimal     @default(0) @db.Decimal(12, 2)
  taxAmount              Decimal     @default(0) @db.Decimal(12, 2)
  totalAmount            Decimal     @default(0) @db.Decimal(12, 2)
  currency               String      @default("SGD")
  freshbooksInvoiceId    String?
  deliveryNotes          String?
  internalNotes          String?
  aiParsedRaw            String?
  aiConfidence           Decimal?    @db.Decimal(3, 2)
  isRecurring            Boolean     @default(false)
  recurrencePattern      Json?
  createdById            String?
  updatedById            String?
  createdAt              DateTime    @default(now())
  updatedAt              DateTime    @updatedAt

  // Relations
  customer               Customer    @relation(fields: [customerId], references: [id])
  lockedBy               User?       @relation("OrderLockedBy", fields: [lockedById], references: [id])
  createdBy              User?       @relation("OrderCreatedBy", fields: [createdById], references: [id])
  updatedBy              User?       @relation("OrderUpdatedBy", fields: [updatedById], references: [id])
  items                  OrderItem[]
  changes                OrderChange[]
  workOrderItems         WorkOrderItem[]

  @@index([customerId])
  @@index([status])
  @@index([requestedDeliveryDate])
  @@index([requestedDeliveryDate, status])
  @@map("orders")
}

model OrderItem {
  id         String   @id @default(uuid())
  orderId    String
  productId  String
  quantity   Decimal  @db.Decimal(10, 2)
  unitPrice  Decimal? @db.Decimal(10, 2)
  totalPrice Decimal? @db.Decimal(12, 2)
  notes      String?
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  // Relations
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model OrderChange {
  id         String   @id @default(uuid())
  orderId    String
  changedById String?
  changeType String?  // 'status_change', 'item_change', 'qty_change'
  oldValue   Json?
  newValue   Json?
  reason     String?
  createdAt  DateTime @default(now())

  // Relations
  order      Order    @relation(fields: [orderId], references: [id])
  changedBy  User?    @relation(fields: [changedById], references: [id])

  @@map("order_changes")
}

// ============================================================
// WORK ORDERS (Production)
// ============================================================

model WorkOrder {
  id             String        @id @default(uuid())
  woNumber       String        @unique // WO-YYYYMMDD-XXXX
  productionDate DateTime      @db.Date
  productionLine ProductionLine
  status         String        @default("planned") // planned, in_progress, completed, cancelled
  plannedStart   DateTime?
  actualStart    DateTime?
  actualEnd      DateTime?
  notes          String?
  createdById    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  createdBy      User?         @relation("WorkOrderCreatedBy", fields: [createdById], references: [id])
  items          WorkOrderItem[]

  @@map("work_orders")
}

model WorkOrderItem {
  id               String    @id @default(uuid())
  workOrderId      String
  productId        String
  bomId            String?
  orderId          String?
  plannedQuantity  Decimal   @db.Decimal(10, 2)
  producedQuantity Decimal   @default(0) @db.Decimal(10, 2)
  wasteQuantity    Decimal   @default(0) @db.Decimal(10, 2)
  wasteReason      String?
  batchNumber      String?
  productionDate   DateTime? @db.Date
  expiryDate       DateTime? @db.Date
  status           String    @default("pending") // pending, in_progress, completed
  sortOrder        Int       @default(0)
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  workOrder        WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  product          Product   @relation(fields: [productId], references: [id])
  bom              Bom?      @relation(fields: [bomId], references: [id])
  order            Order?    @relation(fields: [orderId], references: [id])
  productionReports ProductionReport[]

  @@map("work_order_items")
}

// ============================================================
// PRODUCTION REPORTS
// ============================================================

model ProductionReport {
  id                  String   @id @default(uuid())
  workOrderItemId     String
  reportedById        String?
  quantityProduced    Decimal  @db.Decimal(10, 2)
  quantityWaste       Decimal  @default(0) @db.Decimal(10, 2)
  wasteReason         String?
  batchNumber         String?
  productionTimestamp DateTime @default(now())
  notes               String?
  materialsConsumed   Json?    // [{materialId, quantity, unit}]
  createdAt           DateTime @default(now())

  // Relations
  workOrderItem       WorkOrderItem @relation(fields: [workOrderItemId], references: [id])
  reportedBy          User?         @relation(fields: [reportedById], references: [id])

  @@map("production_reports")
}

// ============================================================
// INVENTORY
// ============================================================

model InventoryStock {
  id                String    @id @default(uuid())
  itemType          ItemType
  rawMaterialId     String?
  productId         String?
  quantityOnHand    Decimal   @default(0) @db.Decimal(12, 3)
  quantityReserved  Decimal   @default(0) @db.Decimal(12, 3)
  lastCountDate     DateTime? @db.Date
  lastCountQuantity Decimal?  @db.Decimal(12, 3)
  location          String?
  updatedAt         DateTime  @updatedAt

  // Relations
  rawMaterial       RawMaterial? @relation(fields: [rawMaterialId], references: [id])
  product           Product?     @relation(fields: [productId], references: [id])

  @@unique([itemType, rawMaterialId, productId])
  @@map("inventory_stock")
}

model InventoryMovement {
  id                    String       @id @default(uuid())
  itemType              ItemType
  rawMaterialId         String?
  productId             String?
  movementType          MovementType
  quantity              Decimal      @db.Decimal(12, 3) // Positive for IN, negative for OUT
  unit                  UnitOfMeasure
  referenceType         String?      // 'purchase_order', 'work_order', 'count', 'adjustment'
  referenceId           String?
  batchNumber           String?
  expiryDate            DateTime?    @db.Date
  supplierInvoiceNumber String?
  xeroInvoiceId         String?
  costPerUnit           Decimal?     @db.Decimal(10, 4)
  totalCost             Decimal?     @db.Decimal(12, 2)
  reason                String?
  reportedById          String?
  createdAt             DateTime     @default(now())

  // Relations
  rawMaterial           RawMaterial? @relation(fields: [rawMaterialId], references: [id])
  product               Product?     @relation(fields: [productId], references: [id])
  reportedBy            User?        @relation(fields: [reportedById], references: [id])

  @@index([itemType, rawMaterialId, productId])
  @@index([createdAt])
  @@index([movementType])
  @@map("inventory_movements")
}

// ============================================================
// PURCHASE ORDERS
// ============================================================

model PurchaseOrder {
  id                   String    @id @default(uuid())
  poNumber             String    @unique // PO-YYYYMMDD-XXXX
  supplierId           String
  status               String    @default("draft") // draft, sent, confirmed, partially_received, received, cancelled
  orderDate            DateTime  @default(now()) @db.Date
  expectedDeliveryDate DateTime? @db.Date
  actualDeliveryDate   DateTime? @db.Date
  deliveryTimeSlot     String?
  subtotal             Decimal   @default(0) @db.Decimal(12, 2)
  taxAmount            Decimal   @default(0) @db.Decimal(12, 2)
  totalAmount          Decimal   @default(0) @db.Decimal(12, 2)
  currency             String    @default("SGD")
  xeroPoId             String?
  notes                String?
  autoGenerated        Boolean   @default(false)
  createdById          String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  supplier             Supplier  @relation(fields: [supplierId], references: [id])
  createdBy            User?     @relation("POCreatedBy", fields: [createdById], references: [id])
  items                PurchaseOrderItem[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id               String        @id @default(uuid())
  purchaseOrderId  String
  rawMaterialId    String
  quantityOrdered  Decimal       @db.Decimal(10, 3)
  quantityReceived Decimal       @default(0) @db.Decimal(10, 3)
  unit             UnitOfMeasure
  unitPrice        Decimal?      @db.Decimal(10, 4)
  totalPrice       Decimal?      @db.Decimal(12, 2)
  notes            String?
  sortOrder        Int           @default(0)

  // Relations
  purchaseOrder    PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  rawMaterial      RawMaterial   @relation(fields: [rawMaterialId], references: [id])

  @@map("purchase_order_items")
}

// ============================================================
// INVENTORY COUNTS
// ============================================================

model InventoryCount {
  id          String    @id @default(uuid())
  countDate   DateTime  @default(now()) @db.Date
  countType   CountType
  status      String    @default("in_progress") // in_progress, completed, approved
  countedById String?
  approvedById String?
  notes       String?
  createdAt   DateTime  @default(now())
  completedAt DateTime?

  // Relations
  countedBy   User?     @relation("CountCounted", fields: [countedById], references: [id])
  approvedBy  User?     @relation("CountApproved", fields: [approvedById], references: [id])
  items       InventoryCountItem[]

  @@map("inventory_counts")
}

model InventoryCountItem {
  id              String   @id @default(uuid())
  countId         String
  itemType        ItemType
  rawMaterialId   String?
  productId       String?
  systemQuantity  Decimal? @db.Decimal(12, 3)
  countedQuantity Decimal  @db.Decimal(12, 3)
  notes           String?

  // Relations
  count           InventoryCount @relation(fields: [countId], references: [id], onDelete: Cascade)

  @@map("inventory_count_items")
}

// ============================================================
// NOTIFICATIONS
// ============================================================

model Notification {
  id        String    @id @default(uuid())
  userId    String?
  channel   String    // 'push', 'email', 'whatsapp', 'in_app'
  type      String    // 'low_stock', 'order_reminder', etc.
  title     Json      // Multi-language
  body      Json      // Multi-language
  data      Json?
  isRead    Boolean   @default(false)
  sentAt    DateTime?
  readAt    DateTime?
  createdAt DateTime  @default(now())

  // Relations
  user      User?     @relation(fields: [userId], references: [id])

  @@map("notifications")
}

// ============================================================
// AUDIT LOG
// ============================================================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  oldData    Json?
  newData    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  // Relations
  user       User?    @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([userId, createdAt])
  @@map("audit_log")
}

// ============================================================
// SYSTEM SETTINGS
// ============================================================

model SystemSetting {
  key         String   @id
  value       Json
  description String?
  updatedAt   DateTime @updatedAt
  updatedById String?

  // Relations
  updatedBy   User?    @relation(fields: [updatedById], references: [id])

  @@map("system_settings")
}
